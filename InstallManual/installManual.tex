\documentclass[a4j, 12pt]{jarticle}
\setlength{\topmargin}{0mm}
\setlength{\textheight}{230mm}
\usepackage{ascmac}

\begin{document}
\title{岡山県立大学シラバス管理システム2009\\インストールマニュアル}
\author{金子　真大 \and 近藤　隆博}
\date{2009年4月1日}
\maketitle

\newpage
\tableofcontents
\newpage

\section{本書について}
本書は2009年度のシラバスシステムのインストールマニュアルです。

\section{シラバスシステム動作環境}
シラバスシステムはLinuxオペレーティングシステムでの動作を想定しています。
実際のシラバスシステムの運用にはVine Linux4.2を用いています。
本書では
\begin{itemize}
\item Vine Linux
\item Fedora
\item Ubuntu
\end{itemize}
を用いた場合のシステムの導入方法について示します。

\section{ソフトウェアのインストール方法}
Linuxにはソフトウェア同士やライブラリの依存関係を管理する仕組みとしてパッケージがあります。パッケージの管理システムにはRPMやAPTやYUMなどのLinuxのディストリビューション毎に様々な形態が用意されています。VineLinuxとUbuntu系(MIE)ではaptを用いてパッケージを管理し、Fedoraではyumを用いてパッケージを管理しています。

%-------------------------apache2のインストール-------------------
\section{apache2のインストール}
\subsection{インストール}
\subsubsection*{Vine Linuxの場合}
Vine Linuxでは完全インストールを選択した場合は標準でインストールされています。
もしインストールされていない場合はaptを用いapache2を導入します。
aptを用いるにはroot(管理者)になる必要があります。ユーザーの切り替えはsuコマンドを用います。suとはswitch userの略で、
書式はsu $"ユーザー名"$です。ユーザー名を省略するとrootにswitchします。\\
\begin{shadebox}
  \$ su\\
  パスワード(P):パスワードを入力\\
  (suした後\$が\#に変わっていれば大体rootです。)\\
  \# apt-get install apache2
\end{shadebox}

\subsubsection*{Fedoraの場合}
Fedora にApacheをインストールします。\\
Apacheのパッケージ名は「httpd」なので、管理者権限でyumを実行します。\\
インストールするコマンドは以下に示します。\\
\begin{shadebox}
  \$ su\\
  \# yum install httpd
\end{shadebox}

\subsubsection*{Ubuntu系(MIE)などの場合}
apacheのAPACHE\_RUN\_USERがapacheではなくwww-dataなので、プロセスの実行者がapacheではなくwww-dataとなります。
したがって、シラバスシステム全体の所有者をwww-dataに変えるか、APACHE\_RUN\_USERをapacheに変更します。
インストールするコマンドは以下に示します。
sudoというのはroot権限で実行するためのコマンドです。\\
sudoと毎回打つのが面倒な場合はsudo suでrootにswitchすればOKです。\\
\begin{shadebox}
  \$ sudo apt-get install apache2
\end{shadebox}

\subsubsection*{ファイヤーウォールの設定}
外部からアクセス出来るようにするためにファイヤーウォールの設定でポート番号80番(HTTPプロトコル)を通すように設定しておきます。

\subsection{apacheの動作確認}
Webブラウザのアドレス欄にlocalhostと入力してみて下さい。It work!と表示されればapacheは動作しています。

%--------------------------phpのインストール-------------------------
\section{phpのインストール}
\subsection{インストール}
\subsubsection*{Vine Linuxの場合}
aptを用いPHP5, PHP5-apache2を導入します。
以下のコマンドを実行します。\\
\begin{shadebox}
  \# apt-get install php5\\
  \# apt-get install php5-apache2\\
  \# rpm -qa |grep php5\\
  (php5関係で何がインストールされたのかをrpmコマンドを用いて確認しています)
\end{shadebox}

\subsubsection*{Fedoraの場合}
以下のコマンドを入力してPHPをインストールします。\\
\begin{shadebox}
  \# su　+　管理者権限パスワード\\
  \# yum install php php-pear php-mbstring php-ldap
\end{shadebox}

\subsubsection*{Ubuntu系（MIEなど）の場合}
php5, libapache2-mod-php5, php5-xslをaptを用い導入します。
以下のコマンドを実行します。\\
\begin{shadebox}
  \$ sudo apt-get install php5\\
  \$ sudo apt-get install libapache2-mod-php5\\
  \$ sudo apt-get install php5-xsl
\end{shadebox}
\\\\

PHPのインストールが終わったらApacheを再起動します。\\
\begin{shadebox}
  \$ sudo /etc/init.d/apache2 restart
\end{shadebox}

\subsection{apacheの設定}
先ほどインストールしたphpが動作するかをテストします。\\
以下のコマンドで/var/www/ディレクトリにtest.phpというPHPファイルを作ります。

Vine Linuxの場合は以下のコマンドです。\\
\begin{shadebox}
  \# gedit /var/www/html/test.php
\end{shadebox}

Ubuntu系（MIEなど）の場合は以下のコマンドです。\\
\begin{shadebox}
  \$ sudo gedit /var/www/test.php
\end{shadebox}

Fedoraの場合の場合は以下のコマンドです。\\
\begin{shadebox}
  \# gedit /var/www/test.php
\end{shadebox}
\\

エディタが立ち上がったら、下記の内容を入力します。
\begin{itembox}[l]{test.phpに記述する内容}
  \verb|<|?php phpinfo(); ?\verb|>|
\end{itembox}
入力後はブラウザで動作確認します。\\
http://localhost/test.php
apacheでphpを実行する設定が出来ていないので、ブラウザ上には\verb|<|?php phpinfo(); ?\verb|>|と文字が表示されるだけです。

phpを実行出来るようにapacheの設定を変更していきます。apacheの設定はhttpd.confなどの設定ファイルに記述していきます。\\

\subsubsection*{Vine Linuxの場合}
/etc/apache2/conf/httpd.confに記述していきます。httpd.confの中にはディレクトリ毎の設定を記述する部分が以下のようにあります。ドキュメントルートでPHPを実行出来ればよいのでドキュメントルートに対しての設定部分に追記していきます。\\
\begin{itembox}[l]{/etc/apache2/conf/httpd.conf変更前}
  \verb|<|Directory "パス"\verb|>|\\
  Options Indexes FollowSymLinks\\

  〜その他そのパスに適応させる色々な設定〜

  \verb|<|/Directory\verb|>|
\end{itembox}

\begin{itembox}[l]{/etc/apache2/conf/httpd.conf変更後}
  \verb|<|Directory "パス"\verb|>|\\
  Options Indexes ExecCGI FollowSymLinks\\

  〜その他そのパスに適応させる色々な設定〜

  \verb|<|/Directory\verb|>|
\end{itembox}

\subsubsection*{Fedoraの場合}
変更内容はVine Linuxの場合と同じです。
\subsubsection*{Ubuntu系（MIEなど）の場合}
Ubuntu系の場合はhttpd.conf ではなく、apache2.confに記述していきます。
変更内容はVine Linuxの場合と同じです。
\subsubsection*{Options項目で利用できるその他の機能}
http.conf(apache2.conf)の＜Directory＞内で利用できる主な設定項目を紹介します。

\begin{itemize}
\item ExecCGI…CGIの実行を許可する
\item FollowSymLinks…設定しているディレクトリ以下にあるファイルやディレクトリへのリンクを有効にする
\item Includes…SSIの実行を許可する
\item IncludesNOEXEC…「\#exec cmd」,「\#exec cgi」以外のSSIの実行を許可する
\item Indexes…クライアントがアクセスしたディレクトリにindex.htmlファイルが存在しない場合に、ディレクトリ内のファイル一覧を表示する
\item MultiViews…コンテンツ･ネゴシエーションで適切な言語のHTMLや画像が選択されるようにする
\item SymLinksIfOwnerMatch…リンク先の所有者がディレクトリの所有者と同一の場合にリンクを有効にする
\item All…MultiViews以外を有効にする
\item None…すべて無効にする
\end{itemize}

\subsubsection*{設定を有効にする}
変更後はその設定を適応させるためにapacheを再起動させます。\\
\begin{shadebox}
  \#service apache2 restart
\end{shadebox}

\subsection{動作確認}
他のPCからもアクセス出来るかどうか、他のPCから自分のPCへアクセスしてみます。まずは、自分のPCだとわかるようにドキュメントルート直下のindex.htmlの内容を書き換えて自分の名前を表示させてみて下さい。次に、自分のPCのIPアドレスを確認するためにifconfigコマンド(InterFace config)を使います。\\
\begin{shadebox}
  \# ifconfig
\end{shadebox}

eth0のint addr:の部分がこのPCのアドレスになります。\\
他のPCブラウザから自分のPCのIPアドレスを入力し自分の編集したページが表示されるか確認してみて下さい。

\subsection{phpの設定}
基本的に全てUTF-8を使う関係上php.iniというphpの設定ファイルにも変更を施します。/etc/php5/php.iniの1342行目のdefalt charset=EUC-JPという行の行頭に;をつけてコメントアウトします。



%---------------------------ptetex------------------------
\section{ptetexのインストール}
シラバスシステムではUTF-8のtexを使うので、teTeXの環境を用います。ptetexはteTeXとpTeX一式を簡単にインストールするための土村展之さん作のツールです。ここでは2005年2月に出た最新のteTeX-3.0とそれをベースにしたpTeXを、ptetex3を使ってインストールします。

\subsection{インストールの準備}
適当なディレクトリを作り、その中にtetex-src-3.0.tar.gz, tetex-texmf-3.0po.tar.gz, ptetex3-20080616.tar.gzをダウンロードします。

\begin{shadebox}
  \$ wget ftp://ftp.ring.gr.jp/pub/text/CTAN/obsolete/systems/unix/teTeX/\\
  3.0/disrib/tetex-src-3.0.tar.gz\\
  \$ wget ftp://ftp.ring.gr.jp/pub/text/CTAN/obsolete/systems/unix/teTeX/\\
  3.0/distrib/tetex-texmf-3.0po.tar.gz\\
  \$ wget http://tutimura.ath.cx/\verb|~|nob/tex/ptetex/ptetex3/ptetex3-20080616\\
  .tar.gz
\end{shadebox}
上記のようにwgetで取ってくるか、ringのCTANミラー(ftp://ftp.ring.gr.jp/)からと土村さんのptetexのHP(http://www.nn.iij4u.or.jp/\verb|~|tutimura/tex/ptetex.html)から取ってきてください。三つのファイルが揃ったら以下のコマンドを実行します。

\begin{shadebox}
  \$ tar xvzf ptetex3-20080616.tar.gz\\
  \$ cd ptetex3-20080616/\\
  \$ cp my\verb|_|option.sample ../my\verb|_|option
\end{shadebox}

OSによって必要なパッケージ・オプションが異なるため、それぞれに分けて記述します。
\subsubsection*{Vine Linuxの場合}
\begin{itembox}[l]{必要パッケージ}
  zlib-devel libpng-devel ncurses-devel\\
  XOrg-devel openMotif-devel t1lib-devel
\end{itembox}

\begin{itembox}[l]{my\_option}
  変更しません。
\end{itembox}

\subsubsection*{Fedoraの場合}
\begin{itembox}[l]{必要パッケージ}
  nkf
\end{itembox}

\begin{itembox}[l]{my\_option}
  以下の点を変更します。\\
  conf\verb|_|option --without-dvipng\\
  conf\verb|_|option --without-dialog\\
 
  JAPANESE=international\\
 
  KANJI\verb|_|CODE=UTF8\\
 
  PLATEX209=no\\
 
  conf\verb|_|option --enable-kanji-iconv\\

  EXTRA\verb|_|TRUETYPE="/usr/share/fonts/VLGothic"
\end{itembox}

\subsubsection*{Ubuntuの場合}
\begin{itembox}[l]{必要パッケージ}
  bison build-essential flex libmotif3\\
  libmotif-dev x11proto-print-dev\\
  xorg-dev
\end{itembox}

\begin{itembox}[l]{my\_option}
  以下の点を変更します。\\
  KANJ\verb|_|CODE=UTF8\\
  SYSTEM\verb|_|FREETYPE2=no
\end{itembox}
Ubuntu/MIEの場合はedを導入してください。

\subsection{インストール}
準備が整ったら以下を実行します。

\begin{shadebox}
  \$ make\\
  あるいはOTF（安定版）、Bable対応を含めるのなら\\
  \$ make all3\\
  あるいは個別に実行するのなら\\
  \$ make all3\\
  \$ make otf  （オプション）\\
  \$ make babel  （オプション）\\
  \$ make font\\
  \$ make test
\end{shadebox}
とします。動作確認が終わったら、システムにインストールします。

\begin{shadebox}
  \$ make install\\
     （必要に応じてsuしたりsudoを付けたりします)
\end{shadebox}

Fedoraの場合は/usr/local/teTeX/share/texmf/web2c/texmf.cnfに
\begin{screen}
  PTEX\_IN\_FILTER=/usr/bin/nkf -w
\end{screen}
と書き加えて漢字コードを自動判定させます。

/usr/local/teTeX/binにパスを通します。PATHの設定には、まず、shellの種類を見分けます。
\begin{itemize}
\item setenvコマンドなし→shかbash(たいていのLinuxのディフォルト)
\item setenvコマンドあり→cshかtcsh
\end{itemize}
あるいは、シェル変数SHELLには、ログイン時のシェルコマンドのフルパスが入っているので、これで見分けることもできます。

\begin{shadebox}
  echo \$SHELL
\end{shadebox}
と入力すると
\begin{screen}
  /bin/bash
\end{screen}
のように表示されます。

\subsubsection*{一時的にPATHを変更}
\begin{screen}
  export PATH=/usr/local/teTeX/bin:\$PATH    \# sh/bash ユーザの場合\\
  setenv PATH /usr/local/teTeX/bin:\$PATH    \# csh/tcsh ユーザの場合
\end{screen}
shellの種類に応じて、どちらか片方を実行します。(csh/tcshならrehashも忘れずに。)その場で、その窓でのみ効力を発揮します。

\subsubsection*{恒久的に設定(個人ユーザの設定)}
shellの種類に応じて \verb|~|/.bashrcや \verb|~|/.tcshrcのどこか一ヶ所にお、上で実行する内容を書き込みます。効力が出るのは、次にloginした時です。

\subsubsection*{恒久的に設定(全ユーザの設定)}
\begin{screen}
  /etc/profile.d/tetex.sh  \# sh/bash ユーザ用\\
  /etc/profile.d/tetex.csh \# csh/tcsh ユーザ用
\end{screen}
のようなファイルを作って上の内容を書きます。ファイルは２つとも作ります。通常 /etc/profile.d/lang.shといったファイルが既にあるはずなので、それにならいます。この設定が有効になるのは、次にloginした時です。

\subsubsection*{シンボリックリンクの設定}
apacheがplatexとdvipdfmxを実行できるようにシンボリックリンクを/bin以下に作成しておきます。\\
\begin{shadebox}
  \$ ln -s /usr/local/teTeX/bin/dvipdfmx /bin/dvipdfmx\\
  \$ ln -s /usr/local/teTeX/bin/platex /bin/platex
\end{shadebox}

\subsection{トラブルシューティング}
\subsubsection{xdvi時のエラー文}
\begin{itembox}[l]{エラー文}
  Warning: Missing charsets in String to FontSet conversion\\
  と表示される。
\end{itembox}
\$TEXMF/xdvi/XDviのリソースを修正すると抑止できることもあります。Xの持つフォントが足りないのかもしれません。xfsを利用するようにXの設定を変更すればよい場合もあるようです。\\
参考：http://lists.debian.or.jp/debian-users/200607/msg00096.html

\subsubsection{make時のエラー文}
\begin{itembox}[l]{エラー文}
  Error: /undefinedresource in --findresource--\\
  Operand stack:\\
  GothicBBB-Medium-Identity-H   Identity-H   --nostringval--\\
  CMap   Identity-H   CMap   Identity-H\\
  Executionstack:\\
  ....\\
  と表示される
\end{itembox}
ps2pdfでPDFを作る途中で失敗してしまうので、問題ではあるのですが、解決にはghostscriptにパッチを当てねばならず、かなり手間がかかります。UTF/OTFパッケージを併用しなければ大丈夫な場合もあるので、その場合は気にしないのがよいでしょう。普通のPSすら変換できないとすれば、ghostscriptのupdateされたものを探してみるのがよいでしょう。ps2pdfのテストを除外するならmy\verb|_|option|に
\begin{screen}
  PSPDF=echo
\end{screen}
と書いておきます。

\end{document}
