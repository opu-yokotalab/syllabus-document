\documentclass[titlepage]{jsarticle}
\title{シラバスシステム引継文書(2009-2010)\\（仕様編）}
\author{岡山県立大学シラバス管理システム2009開発チーム\\2008年度休学 小宮山}
\date{最終更新日:\today}
\begin{document}
\maketitle
\subsection*{本文書の概要}
著者の独断と偏見による、シラバスシステムにおける仕様、及び今後の展望を記述するチラシの裏である。
\section{シラバスシステム概要}
\subsection{概念}
Webフォームから教員が入力を行い、シラバスのPDFを出力するシステム。
%実際は禁止されている前年度データそのまま流用ができ、楽だから使いたいという予想も。

%\subsubsection{データの扱い}
システムダウン時には國島先生がxmlの変換を行いPDFをつくる、
との前提により入力データを全て保持するために文字コードをUTF-8としたxmlを用いている。
ただし、\ref{sec:formdata}%や\ref{sec:treat-single-byte-characters}
も参照。
%というか、数年前まで文字コードもEUC-JPだったし、
%記号は全角に置き換え(しかも動いてなかったり、対応しきれていなかったり)してたし、文字コードとか関係ないんじゃ・・？

xmlからtexの書式にxsltによりtexファイルを生成し、組版後Linuxのdvipdfmxコマンドによりpdfを生成する。
%上記以外の機能は飾りです。偉い人にはわからんのです。


\subsection{半角文字の扱い}\label{sec:treat-single-byte-characters}
半角文字をxmlで正しく扱えるようにした。
また、UTFの文字をpdfやdviに出力するためにotfパッケージを用いている。

Vine4系のtexmacro-otfではうまくいかなかった(フォント)ため、
http://mytexpert.sourceforge.jp/を参考にし、土村さん(http://www.nn.iij4u.or.jp/~tutimura/tex/ptetex.html)のptex3をalphaにインストールしている。
具体的には、tetex-texmf-3.0-1.noarch.rpm(tetex-texmf-3.0-1)とVine4-ptetex3-20071003-1.i386.rpm(ptetex3-20071003-1)である。

またtexやxmlの記法にも対応している。
シラバス登録内容における文字列の変換について\ref{tab:strchange}に示す。
\begin{table}
\begin{center}
\label{tab:strchange}
\caption{文字変換表}
\begin{tabular}{|c|c|c|c|} \hline
 入力& xml& str2otf.php&  (XSLT)tex\\ \hline\hline
 $\langle$ & \&lt; & \$$\backslash$langle\$ & \$$\backslash$langle\$ \\ \hline
 $\rangle$ & \&gt; & \$$\backslash$rangle\$ & \$$\backslash$rangle\$ \\ \hline
 \& & \&amp; & $\backslash$\&amp; & $\backslash$\& \\ \hline
 " & \&quot; & $\backslash$\&quot; & " \\ \hline
 ' & \&apos; & $\backslash$\&apos; & ' \\ \hline
 \# & \# & $\backslash$\# & $\backslash$\# \\ \hline
 \$ & \$ & $\backslash$\$ & $\backslash$\$ \\ \hline
 \% & \% & $\backslash$\% & $\backslash$\% \\ \hline
 \_ & \_ & $\backslash$\_ & $\backslash$\_ \\ \hline
 \{ & \{ & $\backslash$\{ & $\backslash$\{ \\ \hline
 \} & \} & $\backslash$\} & $\backslash$\} \\ \hline
 $\backslash$ & $\backslash$ & \$$\backslash$backslash\$ & \$$\backslash$backslash\$ \\ \hline
 {-} & {-} & \{{-}\} & \{{-}\} \\ \hline
 \~{} & \~{} & $\backslash$\~{}\{\} & $\backslash$\~{}\{\} \\ \hline
 \^{} & \^{} & $\backslash$\^{}\{\} & $\backslash$\^{}\{\} \\ \hline
 $*$ & $*$ & \$$*$\$ & \$$*$\$ \\ \hline
 $|$ & $|$ & \$$|$\$ & \$$|$\$ \\ \hline
 その他の&&&\\半角記号 & そのまま & そのまま & そのまま \\
 等&&&\\ \hline
 上記以外 & そのまま & $\backslash$\{\($unicodeの値$\)\} & $\backslash$\{\($unicodeの値$\)\} \\ \hline
 \end{tabular}
\end{center}
\end{table}
更にこの対応からhtmlspecialcharsの仕様により、教科名に「\'」が使われた場合の処理が必要となった。
この処理についてはhtmlspecialchars及びpreg\_replaceを用いた自作関数xml\_ent及びxml\_ent\_deで行っている。

\newpage
\section{画面遷移図と機能}
%\section{ファイル配置}
\section{構成ファイル}
\subsection{設定ファイル}\label{sec:config-file}

\subsubsection{value.inc}\label{sec:value-inc}
各種ファイルで使用される変数を定義しています。定義一覧

\begin{itemize}
\item シラバスシステムのバージョン情報
\item PHPファイル、セッションファイル、パスワードファイルのファイルパス
\item セッションクッキーパス
\item communications = 情報通信工学科　などの実学科名とプログラム中で使用している学科名との対応付け
\end{itemize}
\subsection{.htaccess}
アクセス制限や、phpの設定を行っている。

アクセス制限は運用に基づいて変更する。cronの利用もあり得る。

phpの設定はphp.iniや各phpファイル中での設定、set\_ini()等でも可能である。
%\begin{center}
%\begin{tabular}{|c|c|} \hline
%php\_value mbstring.http\_input pass & 入力データは手動処理\\ \hline
%php\_value arg_separator.output \&amp; & 引数はアンパサampersandで区切る \\ \hline
%php\_flag session.use\_only\_cookies Off & \\ \hline
%php\_flag session.use\_trans\_sid 1 & \\ \hline
%php\_value session.cache\_limiter none & \\ \hline
%アクセス制限 & 必要に応じて\\ \hline
%\end{tabluar}
%\end{center}

%\begin{center}
%\begin{tabular}{|c|c|} \hline
%処理概要 & \\ \hline
%呼出元 & \ref{}\\ \hline
%呼出先 & \ref{}\\ \hline
%その他の関連ファイル & \ref{}\\ \hline
%\end{tabular}
%\end{center}
%\subsubsection{説明}
%\subsubsection{プログラムリスト}
%\begin{verbatim}
%
%\end{verbatim}
\subsection{index.php}\label{sec:index-php}
\begin{center}
\begin{tabular}{|c|c|} \hline
処理概要 & ログインフォームの出力、ログアウト処理\\ \hline
requre\_once & value.inc  \\ \hline
requre & \$session\_start\_php、\$session\_end\_php \\ \hline
その他の関連ファイル & top.css \\ \hline
\end{tabular}
\end{center}
\begin{description}
 \item[通常] 
ログイン画面を出力。
 \item[ログアウト時] 
\_GET[logout]がある場合、ログアウト処理
\end{description}
\subsubsection{プログラムリスト}
\begin{verbatim}

\end{verbatim}

\subsection{view\_user\_class.php}\label{sec:view-user-class-php}
\begin{center}
\begin{tabular}{|c|c|} \hline
処理概要 & 一覧画面出力、各種メニュー表示、ログイン処理 \\ \hline
requre\_once & value.inc  \\ \hline
requre & \$session\_start\_php \\ \hline
その他の関連ファイル & SCS.css \\ \hline
\end{tabular}
\end{center}
\begin{description}
 \item[通常] 
 セッションチェック
 \item[ログイン時] 
 セッション変数のセットまたはセッションエラー処理
 \item[一般ユーザ] 
 所有科目の一覧とメニューを出力
 \item[管理者ユーザ] 
 全科目一覧とメニュー、教員管理目メニューを出力
\end{description}
\subsubsection{プログラムリスト}
\begin{verbatim}

\end{verbatim}
\subsection{edit.php}\label{sec:edit-php}
\begin{center}
\begin{tabular}{|c|c|} \hline
処理概要 & 内容入力・編集画面出力、 xml内容変更、\\
 & xslt実行(tex生成)、組版(dvi生成)、pdf生成\\ \hline
requre\_once & value.inc、str2otf.php  \\ \hline
requre & \$session\_start\_php、\$session\_check\_php \\ \hline
その他の関連ファイル & edit.css \\ \hline
\end{tabular}
\end{center}
\begin{description}
 \item[通常] 
 編集フォーム出力
 \item[フォームデータ受信] 
 \$\_POST[\'mode\']がedならば、xml内容変更、xslt実行(tex生成)を行い、システムへ組版とpdf生成コマンドを投げる。その後生成結果を表示。
 \item[エラー時] 
 ログインし直してくださいというエラーページを出力。
\end{description}
\subsubsection{プログラムリスト}
\begin{verbatim}

\end{verbatim}

\subsection{regist\_user.php}\label{sec:regist-user-php}
\begin{center}
\begin{tabular}{|c|c|} \hline
処理概要 & 新規教員の登録 \\ \hline
requre\_once & \$value.inc  \\ \hline
requre & \$session\_start\_php、\$session\_check\_php \\ \hline
その他の関連ファイル & \$FILE\_PASSWD、\$FILE\_PASSWDNEW、maintenance.css \\ \hline
\end{tabular}
\end{center}
\begin{description}
 \item[通常] 
 登録フォーム出力
 \item[フォームデータ受信時] 
 \$\_POST[in]が1ならば、内容チェック、教員データ登録処理
 \item[入力データエラー時] 
 エラーメッセージを出力
\end{description}
\subsubsection{プログラムリスト}
\begin{verbatim}

\end{verbatim}

\subsection{delete\_user.php}\label{sec:delete-user-php}
\begin{center}
\begin{tabular}{|c|c|} \hline
処理概要 & 教員の削除 \\ \hline
requre\_once & \$value.inc  \\ \hline
requre & \$session\_start\_php、\$session\_check\_php、(\$session\_check\_php) \\ \hline
その他の関連ファイル & \$FILE\_PASSWD、\$FILE\_PASSWDNEW、maintenance.css \\ \hline
\end{tabular}
\end{center}
\begin{description}
 \item[通常]
 アカウントチェック 
 \item[管理者ユーザ] 
 フォームを出力
 \item[フォームデータ受信] 
 \$\_POST[in]が1ならば、内容チェック、教員データ削除処理。
 また\$\_POST[deleteflag]がcheckedならば、xml、pdfファイルも同時に削除する。
 \item[教員データ未選択時] 
 エラーメッセージを出力。
\end{description}
\subsubsection{プログラムリスト}
\begin{verbatim}

\end{verbatim}

\subsection{change\_pass.php}\label{sec:change-pass-php}
\begin{center}
\begin{tabular}{|c|c|} \hline
処理概要 & パスワード変更 \\ \hline
requre\_once & \$value.inc  \\ \hline
requre & \$session\_start\_php、\$session\_check\_php \\ \hline
その他の関連ファイル & \$FILE\_PASSWD、\$FILE\_PASSWDNEW、maintenance.css \\ \hline
\end{tabular}
\end{center}
\begin{description}
 \item[通常] 
ユーザーのパスワードの変更フォームを出力
 \item[フォームデータ受信]
  \$\_POST[\'in\']が1のときに入力データのチェック
 \item[受信データ不備]
 エラーメッセージを出力 
\end{description}
\subsubsection{プログラムリスト}
\begin{verbatim}

\end{verbatim}

\subsection{regist\_class.php}\label{sec:regist-class-php}
\begin{center}
\begin{tabular}{|c|c|} \hline
処理概要 & 新規科目登録 \\ \hline
requre\_once & \$value.inc  \\ \hline
requre & \$session\_start\_php、\$session\_check\_php\\ \hline
その他の関連ファイル & list.txt(、list.new)、maintenance.css \\ \hline
\end{tabular}
\end{center}
\begin{description}
 \item[通常]
 科目登録フォームを出力 
 \item[フォームデータ受信]
 list.txtへの科目データ追加、当該科目のxml作成。
 \item[科目名がない場合] 
 エラーページを出力
\end{description}
\subsubsection{プログラムリスト}
\begin{verbatim}

\end{verbatim}

\subsection{delete\_class.php}\label{sec:delete-class-php}
\begin{center}
\begin{tabular}{|c|c|} \hline
処理概要 & 科目削除 \\ \hline
requre\_once & \$value.inc  \\ \hline
requre & \$session\_start\_php、\$session\_check\_php\\ \hline
その他の関連ファイル & list.txt(、list.new)、maintenance.css \\ \hline
\end{tabular}
\end{center}
\begin{description}
 \item[通常]
 削除確認画面を出力
 \item[フォームデータ受信時]
 \$\_POST[\'mode\']がinternalであれば科目削除処理 
 \item[引数なし]
 open errorを表示。本来は\$departがない場合、科目が存在しない場合のエラー処理が必要。
\end{description}
\subsubsection{プログラムリスト}
\begin{verbatim}

\end{verbatim}

\subsection{chown\_class.php}\label{sec:chown-class-php}
\begin{center}
\begin{tabular}{|c|c|} \hline
処理概要 & 科目所有者変更 \\ \hline
requre\_once & \$value.inc  \\ \hline
requre & \$session\_start\_php、\$session\_check\_php\\ \hline
その他の関連ファイル & list.txt(、list.new)、maintenance.css \\ \hline
\end{tabular}
\end{center}
\begin{description}
 \item[通常]
 科目の所有教員変更フォームを出力
 \item[フォームデータ受信時]
 \$\_POST[\'mode\']がinternalであり、データが揃っていれば科目削除処理を行う。 
 \item[引数なし]
 エラーを表示。
\end{description}
\subsubsection{プログラムリスト}
\begin{verbatim}

\end{verbatim}

\subsection{view\_all\_class.php}\label{sec:view-all-class-php}
\begin{center}
\begin{tabular}{|c|c|} \hline
処理概要 & 科目一覧出力 \\ \hline
requre\_once & \$value.inc  \\ \hline
requre & \\ \hline
その他の関連ファイル & list.txt(、list.new)、SCS.css \\ \hline
\end{tabular}
\end{center}
\begin{description}
 \item[全てのアクセス]
 全科目の一覧を表示し、pdfファイルへのリンクを提供する。
\end{description}
\subsubsection{プログラムリスト}
\begin{verbatim}

\end{verbatim}

\subsection{str2otf.php}\label{sec:str2otf-php}
\begin{center}
\begin{tabular}{|c|c|} \hline
処理概要 & xmlから\LaTeX (otf)への文字列変換を行う。 \\ \hline
requre\_once & \\ \hline
requre & \\ \hline
その他の関連ファイル & edit.php  \\ \hline
\end{tabular}
\end{center}
\begin{description}
 \item[edit.phpから]
 xmlのパースと文字の変換を行う。 
\end{description}
\subsubsection{プログラムリスト}
\begin{verbatim}

\end{verbatim}

% セッションファイル
%\subsection{Sessionファイル}\label{sec:session-file}

\subsection{session\_start.inc}\label{sec:sesion-start-inc}
セッションを開始します。セッション名はsyllabusです。

\subsection{session\_check.inc}\label{sec:session-check-inc}
セッションファイルが作成されてないユーザー（ログインしていないユーザー）は$index.php$にリダイレクトされます。

\subsection{session\_end.inc}\label{sec:session-end-inc}
セッションファイルを削除します。セッションファイルと共にクッキーファイルも削除します。

% cssファイル
\subsection{CSSファイル}\label{sec:css-file}
CSSファイルリスト

\begin{itemize}
\item edit.css
\item maintenance.css
\item SCS.css
\item top.css
\item use.css
\end{itemize}


\section{既知のバグリスト}
\begin{itemize}
 \item エラー処理の不足
 \item クオート関係の文字処理(texの歴史による部分)
 \item pdfに出ない文字が存在する(フォントの不足)
% \item 教員が未入力の場合PDF生成に失敗（対応済み）
 \item 一度PDF生成に失敗するとxmlにアクセスできない。そのため１から入力し直しとなる
% \item 何か書こうとしたけど忘れた。 × 沢山
 \item workdirにファイルが溜まる。(残すようにしているだけ、コメントアウトを外す)
 \item UTF-8の範囲外の機種依存文字には全く対応していない。携帯とか。%いらないけど
 \item pdfに出ない文字が存在する(フォントの不足)
\end{itemize}

\section{改修予定候補リスト}
\begin{itemize}
 \item 一覧へ戻るリンク追加
 \item texやフォントのアップデート
 \item 科目の学科間コピー、移動機能
 \item 新規科目登録時に所有教員を選択する機能(rootのみ)
\end{itemize}

\section{参考技術情報}
\subsection{セッション}
\subsection{\LaTeX とPDF}
\subsubsection{文字の扱いと組版}
\subsubsection{otfパッケージ}
\subsection{フォームデータの文字コード}\label{sec:formdata}
ブラウザから送られてくるデータの文字コードは不明である。

例えば、form要素のaccept-charsetについてInternetExplorerが未対応という問題がある。



%\subsubsection{きょうじゅかいのせんせいがたへ　おねがい}
%\begin{itemize}
% \item しごとは、はやめにください。のうきだけはやくしないでください。
% \item しごとないようは、はやくかくていしてください。
% \item てんぷれーとは、てふでください。わーどからかきなおすとかやりにくいです。
% \item じょうほうは、はやめにください。
% \item かえてほしいことは、はっきりいってください。
% \item たんとうしゃをかいぎにださせないのは、こっかい、しぎかいくらいかとおもってました。いまだにおやくしょしごとなんですね。
% \#まあ、ながばなしをきかされてもこまるだけですけどね。
%\end{itemize}
\end{document}
