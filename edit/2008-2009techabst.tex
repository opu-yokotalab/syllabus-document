\documentclass[titlepage]{jsarticle}
\title{シラバスシステム引継文書(2008-2009)\\（実装概要編）}
\author{シラバスシステム開発チーム2008 M1 小宮山}
\date{最終更新日:\today}
\begin{document}
\maketitle
\subsection*{本文書の概要}
著者の独断と偏見による、シラバスシステムにおける変更点と今後の展望を記述するチラシの裏。
\section{2008年度システムにおける変更の概要}
%\subsection{基本理念}
%・動くこと
%・ユーザの入力をそのままに保存
%%出力ではフォントが制限されるかもしれないが、元のデータは保持し必要があれば（本システムを用いずに人手による）他の方法で出力が作成できること。できれば入力したままに出力できること。
%・実行系の統一、標準の採用
\subsection{実装}
perlからphp5に実装が変更された。
これにより、処理系におけるperl,bash,java,xalan,rubyの部分がphp5に統一された。
しかし、perlシステムをサブシステムとして並行運用する（互換性確保）ために、単体の設計では不要な仕様が存在している。
これについては、文字の処理をはじめとしシステム全体の設計にまで波及している。
\subsection{サーバ側の設定}
phpの設定についてデフォルトから変更を行っている。
php.ini,.htaccess
\subsection{texのパッケージとフォント}
UTFの文字をpdf(dviも)に出力するためにotfパッケージを用いている。

Vineのtexmacro-otfではうまくいかなかった(フォント)ため、
http://mytexpert.sourceforge.jp/を参考にし、土村さん(http://www.nn.iij4u.or.jp/~tutimura/tex/ptex.html)のptex3をalphaにインストールしている。
具体的には、tetex-texmf-3.0-1.noarch.rpm(tetex-texmf-3.0-1)とVine4-ptetex3-20071003-1.i386.rpm(ptetex3-20071003-1)である。
\subsection{XMLエンコーディング}
EUC-JPからUTF-8に変更した。

\section{問題点の概要と展望}
ここでは2008年度のシステムにおいて発生または発覚した、あるいは改善されていない点について述べる。
\section{文字データ}
\subsection{2008年度システム内部の文字データ変遷}
フォームから送信された文字列の文字コードは入力環境依存であるために、
phpで受取る段階でUTF-8に変換している。これはphpのmb\_conbert\_encoding関数を用いているが、期待の動作を得るためにphpの環境設定をデフォルトから変更している。
また、後述の互換性問題により\verb|&、>、>、"、'、_|を全角に置き換えている。

次にこれらの文字列を用いてXMLを作成し保存する。
XSLTをもちいてこのXMLからtexファイルを作成するのだが、そのままでは対応するPDF、dvi用のフォントがなく、期待する出力が得られない。そのため、otfパッケージの\verb|\UTF{UTF-8の文字コード}|という命令に変換する必要がある。ただし、出力時の文字の間隔や、texの禁則処理のために、アルファベットと括弧や句読点などはそのままにしておく。また、この時点でtexにおける特殊文字の置換も行っている。
これらの処理を行う関数str2otfを実装している。


またXSLTを行うために、ここではじめてXMLとして扱われる。(半角空白の削除に注意)

XSLTを用いて作成されたtexファイルの文字コードはUTF-8になっているが、現状では特に意味は無い。

その後dvi、pdfと生成されていく。ここでフォントが埋め込まれるわけではないことに注意すべきである。

実際に該当するのはかなり特殊な文字だけであるが、Adobe-Japanのフォントが用いられる。これの埋め込みはライセンスに抵触する恐れが高いため埋め込みは行っていない。これらのフォントであるAdob-Japan-1-5程度はAdobe Reader 7.0以上で閲覧、あるいは不足フォントとして自動ダウンロードが可能である。またMac OSXのPDFビューワ（何か忘れた）も対応していた。
非対応のビューワでは当該文字が表示されない問題がある。
\subsection{問題となる文字}
\begin{verbatim}
文字 エスケープ等　現状

xml

< 　&lt;     ＜
> 　&gt; 　　＞
& 　&amp;　　＆
" 　&quot; 　”
' 　&apos; 　’

tex
# 　\#　　　\#
$ 　\$　　　\$
% 　\%　　　\%
& 　\&　　　＆
_ 　\_　　　＿
{ 　\{　　　\{
} 　\}　　　\}
\ 　$\backslash$ $\backslash$
-   {-}     未対応
~   \~{}    \~{}
^   \^{}    \^{}
*   $*$     $*$
|   $|$     $|$
括弧や句読点等　そのまま　そのまま

php文字列
'　  \'
"　 \"
\ 　\\
t 　\t
n　 \n
$　 \$
r　 \r
\end{verbatim}
\subsection{文字における諸問題}
\subsubsection{入力}
フォームから送信された文字列をphpで受取ったときにUTF-8に変換している。

フォームから送信されるデータは、クライアントの環境、主にブラウザに依存する。
ここで文字コードの変換の精度や繰り返すデメリットを考えれば、システム内で文字コードについて一貫性を確保した方が良い。また、ユーザの意図した文字を扱えることを考慮すると、カバーする文字種からUTF-8が適していると考えられる。

\subsubsection{旧perlシステム互換}
一部の半角文字を入力の段階で全角に置き換えている問題である。
置き換えられている文字はxmlで文字実体参照で表現されるべき\verb|&,<,>,",'|と\_である。互換性を考慮しなくてよい2009年度システム以降では改善されるべき点である。
\subsubsection{XML処理}
前述の文字実体参照と空白の扱いである。
これらは適切に扱われるようにすべきである。
\subsubsection{tex組版における制約}
texにおける特殊文字、禁則処理、otfパッケージの使用を考慮しなくてはならない問題である。現状では自作関数str2otfで対処しているが、前述の文字実体参照を考慮すると実装を変更する必要がある。また、otfパッケージの命令に変換する部分ではUpTex,UplaTex（現状ではα版）等を用いることでそのまま扱えるようにするのが望ましい。
\section{来年度以降への対応策提案}

\subsection{Session管理}
現在のシステムでは旧来のシステムを元にしているため、セッション管理が不十分である。

phpで実装する利点を活かし、ログイン情報をブラウザを閉じるまで保持するようにセッションを用いること推奨する。
\subsection{コーディング}
変数と出力部分の分離を行う等、読みやすいコーディングを行うべきであると考えられる。また、アーキテクチャを見直しにより変数の整理が可能だと考えられる。
\subsection{セキュリティ}
ファイル名をはじめ、ログイン時のエラーメッセージ等からユーザ名が存在するかどうか確認可能である。一般的には重大なセキュリティホールといっても過言ではないが、運用を考えると本件の重要度は低いと考えられる。

しかしシステム全体について、セキュリティの再検証を行う必要性は十分にあると考えられる。
\subsection{php6.0}
Unicodeが扱えるようになる。
関数がUTF-8に対応するため、現状のような処理や設定などが不要になり、システムのメンテナンス性が向上できると考えられる。
\subsection{UpTex/UplaTex}
UTFで記述し、そのまま組版が可能。ただし現在α版。

\subsection{PDFLib}
phpの有償ライブラリ。
phpから直接PDFを作成できる。
上位版ではテンプレートのPDFに文字列を流し込むことが可能である。
%\subsubsection*{あとがき}


\end{document}
